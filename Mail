import re
import smtplib
import imaplib
import email
from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart
from email.header import decode_header
import threading
import time
from typing import Tuple, Optional
import logging

# Настройка логирования
logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')
logger = logging.getLogger(__name__)

class EmailOptimizer:
    def __init__(self, email_address: str, password: str, imap_server: str, smtp_server: str):
        self.email_address = email_address
        self.password = password
        self.imap_server = imap_server
        self.smtp_server = smtp_server
        
        # Ключевые слова для определения спама (можно расширить)
        self.spam_keywords = [
            'акция', 'распродажа', 'кредит', 'займ', 'казино', 
            'лотерея', 'выигрыш', 'бесплатно', 'срочно', 'urgent',
            'discount', 'sale', 'lottery', 'casino', 'credit'
        ]
        
        # Ключевые слова для важных писем
        self.important_keywords = [
            'работа', 'резюме', 'договор', 'счет', 'invoice',
            'важно', 'important', 'срочно', 'urgent', 'проект',
            'встреча', 'meeting', 'отчет', 'report'
        ]

    def detect_language(self, text: str) -> str:
        """Определяет язык текста"""
        # Простая эвристика для определения языка
        russian_chars = len(re.findall(r'[а-яё]', text.lower()))
        chinese_chars = len(re.findall(r'[\u4e00-\u9fff]', text))
        
        if chinese_chars > russian_chars:
            return 'zh'
        else:
            return 'ru'

    def translate_text_simple(self, text: str, target_lang: str) -> str:
        """
        Упрощенный перевод текста.
        В реальном приложении следует использовать API переводчика (Google Translate, Yandex Translate и т.д.)
        """
        # Заглушка для демонстрации
        # В реальном проекте подключите библиотеку перевода, например:
        # from googletrans import Translator
        # translator = Translator()
        # return translator.translate(text, dest=target_lang).text
        
        translation_map = {
            'ru-zh': {
                'привет': '你好',
                'спасибо': '谢谢',
                'письмо': '信',
                'работа': '工作',
                'важно': '重要'
            },
            'zh-ru': {
                '你好': 'привет',
                '谢谢': 'спасибо',
                '信': 'письмо',
                '工作': 'работа',
                '重要': 'важно'
            }
        }
        
        source_lang = 'ru' if target_lang == 'zh' else 'zh'
        key = f"{source_lang}-{target_lang}"
        
        if key in translation_map:
            for word, translation in translation_map[key].items():
                text = text.replace(word, translation)
        
        return f"[ПЕРЕВОД {source_lang.upper()}->{target_lang.upper()}] {text}"

    def is_spam(self, subject: str, body: str) -> bool:
        """Определяет, является ли письмо спамом"""
        content = (subject + ' ' + body).lower()
        
        # Проверка на спам-ключевые слова
        spam_score = sum(1 for keyword in self.spam_keywords if keyword in content)
        
        # Проверка на важные ключевые слова (уменьшает вероятность спама)
        important_score = sum(1 for keyword in self.important_keywords if keyword in content)
        
        return spam_score > important_score + 1  # Порог можно настроить

    def process_email(self, msg) -> Tuple[str, str]:
        """Обрабатывает одно письмо"""
        subject = ""
        body = ""
        
        # Декодируем тему письма
        subject_header = msg.get("Subject", "")
        if subject_header:
            decoded_parts = decode_header(subject_header)
            subject = ""
            for part, encoding in decoded_parts:
                if isinstance(part, bytes):
                    if encoding:
                        subject += part.decode(encoding)
                    else:
                        subject += part.decode('utf-8', errors='ignore')
                else:
                    subject += part
        
        # Извлекаем текст письма
        if msg.is_multipart():
            for part in msg.walk():
                content_type = part.get_content_type()
                content_disposition = str(part.get("Content-Disposition"))
                
                if content_type == "text/plain" and "attachment" not in content_disposition:
                    try:
                        payload = part.get_payload(decode=True)
                        if payload:
                            body = payload.decode('utf-8', errors='ignore')
                            break
                    except:
                        continue
        else:
            content_type = msg.get_content_type()
            if content_type == "text/plain":
                try:
                    payload = msg.get_payload(decode=True)
                    if payload:
                        body = payload.decode('utf-8', errors='ignore')
                except:
                    pass
        
        return subject, body

    def sort_emails(self):
        """Сортирует письма по папкам"""
        try:
            # Подключаемся к почтовому серверу
            mail = imaplib.IMAP4_SSL(self.imap_server)
            mail.login(self.email_address, self.password)
            mail.select("inbox")
            
            # Ищем непрочитанные письма
            status, messages = mail.search(None, 'UNSEEN')
            email_ids = messages[0].split()
            
            for email_id in email_ids:
                try:
                    # Получаем письмо
                    status, msg_data = mail.fetch(email_id, '(RFC822)')
                    msg = email.message_from_bytes(msg_data[0][1])
                    
                    subject, body = self.process_email(msg)
                    
                    # Определяем язык и переводим
                    detected_lang = self.detect_language(subject + ' ' + body)
                    target_lang = 'zh' if detected_lang == 'ru' else 'ru'
                    
                    translated_subject = self.translate_text_simple(subject, target_lang)
                    translated_body = self.translate_text_simple(body, target_lang)
                    
                    # Определяем категорию письма
                    if self.is_spam(subject, body):
                        folder = "spam"
                        logger.info(f"Письмо '{subject[:50]}...' помечено как СПАМ")
                    else:
                        folder = "important"
                        logger.info(f"Письмо '{subject[:50]}...' помечено как ВАЖНОЕ")
                    
                    # Перемещаем письмо в соответствующую папку
                    self.move_email(mail, email_id, folder)
                    
                    # Отправляем ответ с переводом (опционально)
                    self.send_translation_reply(msg, translated_subject, translated_body, target_lang)
                    
                except Exception as e:
                    logger.error(f"Ошибка обработки письма {email_id}: {str(e)}")
                    continue
            
            mail.close()
            mail.logout()
            
        except Exception as e:
            logger.error(f"Ошибка подключения к почте: {str(e)}")

    def move_email(self, mail, email_id: bytes, folder: str):
        """Перемещает письмо в указанную папку"""
        try:
            # Создаем папку если её нет
            mail.create(folder)
        except:
            pass  # Папка уже существует
        
        # Копируем письмо в новую папку
        mail.copy(email_id, folder)
        # Помечаем оригинал для удаления
        mail.store(email_id, '+FLAGS', '\\Deleted')
        mail.expunge()

    def send_translation_reply(self, original_msg, translated_subject: str, translated_body: str, target_lang: str):
        """Отправляет ответ с переводом (опциональная функция)"""
        try:
            # Определяем отправителя оригинального письма
            from_email = original_msg.get('From', '')
            original_subject = original_msg.get('Subject', '')
            
            # Создаем ответное письмо
            reply_msg = MIMEMultipart()
            reply_msg['From'] = self.email_address
            reply_msg['To'] = from_email
            reply_msg['Subject'] = f"Перевод: {translated_subject}"
            reply_msg['In-Reply-To'] = original_msg['Message-ID']
            
            # Добавляем текст перевода
            lang_name = "китайский" if target_lang == 'zh' else "русский"
            body_text = f"""
            Автоматический перевод письма на {lang_name} язык:
            
            Оригинальная тема: {original_subject}
            
            Переведенный текст:
            {translated_body}
            
            ---
            Это автоматическое сообщение от системы оптимизации почты.
            """
            
            reply_msg.attach(MimeText(body_text, 'plain', 'utf-8'))
            
            # Отправляем письмо
            with smtplib.SMTP_SSL(self.smtp_server, 465) as server:
                server.login(self.email_address, self.password)
                server.send_message(reply_msg)
                
            logger.info(f"Отправлен перевод письма для {from_email}")
            
        except Exception as e:
            logger.error(f"Ошибка отправки перевода: {str(e)}")

    def start_monitoring(self, interval: int = 300):
        """Запускает мониторинг почты в фоновом режиме"""
        def monitor():
            while True:
                try:
                    self.sort_emails()
                    time.sleep(interval)
                except Exception as e:
                    logger.error(f"Ошибка в мониторе: {str(e)}")
                    time.sleep(60)  # Ждем перед повторной попыткой
        
        thread = threading.Thread(target=monitor, daemon=True)
        thread.start()
        logger.info(f"Мониторинг почты запущен (интервал: {interval} сек)")

# Пример использования
if __name__ == "__main__":
    # Настройки почты (замените на свои)
    EMAIL_CONFIG = {
        'email_address': 'your_email@example.com',
        'password': 'your_password',
        'imap_server': 'imap.example.com',
        'smtp_server': 'smtp.example.com'
    }
    
    # Создаем оптимизатор
    optimizer = EmailOptimizer(**EMAIL_CONFIG)
    
    # Запускаем мониторинг
    optimizer.start_monitoring(interval=300)  # Проверка каждые 5 минут
    
    # Для однократной проверки можно использовать:
    # optimizer.sort_emails()
    
    # Держим программу активной
    try:
        while True:
            time.sleep(1)
    except KeyboardInterrupt:
        logger.info("Мониторинг остановлен")
